[toc]

### 一、缓存概述

#### 1. 缓存简介

缓存原指CPU上的一种高速存储器

它先于内存与CPU交换数据，速度很快现在泛指存储在计算机上的原始数据的复制集，便于快速访问。

在互联网技术中，缓存是系统快速响应的关键技术之一以空间换时间的一种技术（艺术）

![image-20211219002000277](images/image-20211219002000277.png)





#### 2. 缓存分类

![image-20211219001124074](images/image-20211219001124074.png)

##### 2.1 客户端缓存

- H5 缓存

  WebStorage、WebSql、ApplicationCache等

- 浏览器缓存

- APP缓存

  原生APP中把数据缓存在内存、文件或本地数据库（SQLite）中。比如图片文件

##### 2.2 网络端缓存

- Web代理缓存

  Nginx可以缓存静态资源，如样式、图片、html等

- 边缘缓存

  典型的是CDN（内容分发网络），通过部署各地边缘服务器存储和分发内容，使用户就近获取内容，降低网络拥塞，提供响应速度。

##### 2.3 服务端缓存

- 服务器本地缓存

  GuavaCache、CurrentHashMap、EhCache等

- 中间件缓存

  Redis、Memcached、EVCache（AWS）、Tair（阿里、美团）等

- 数据库缓存

  Mysql在Server层使用了Cache缓存结果，InnoDB存储引擎使用BufferPool等缓存page页





#### 3. 缓存缓存优势与挑战

##### 3.1 优势

- 提升用户体验

- 提升系统性能（响应时间、吞吐量、并发量）
- 减轻DB压力

##### 3.2 挑战

- 额外的硬件支出
- 缓存穿透/雪崩/击穿
- 无法与数据库实时同步





#### 4. 缓存的读写模式

##### 4.1 Cache Aside Pattern（常用，旁路缓存模式）

- 读

  ==先读缓存，缓存没有则再查库，将数据加载进缓存，返回数据==

  ![image-20211220171852240](images/image-20211220171852240.png)

- 更新

  ==先更新数据库，然后再删除缓存==

  为何不是更新缓存？

  - 若缓存是list、hash或者set结构，可能需要大量遍历修改数据耗时太大
  - 可能存在并发问题

  ![image-20211220172016230](images/image-20211220172016230.png)

- 并发问题

  - **先更新库，再更新缓存**：事务update但还未commit时，更新缓存完成，但是commit失效，事务回滚，缓存与库数据不一致
  - **先删除缓存，再更新数据库**：删除缓存完成，事务update但还未commit，此时有读请求进来读到read-view旧数据的视图并加载进缓存，数据库commit成功，缓存与库数据不一致
  - **先更新库，再删除缓存（同上）**：事务update但还未commit时，删除缓存完成，此时有读请求进来读到read-view旧数据的视图并加载进缓存，数据库commit成功，缓存与库数据不一致

- 解决并发问题

  ==先更新库，再删除缓存，并采用延时双删策略==



##### 4.2 Read/Write Through Pattern（直读/直写模式）

应用程序只操作缓存，缓存操作数据库，需要提供数据库的handler，开发较为复杂

- 直读

  应用程序读缓存，缓存没有，由缓存回源到数据库，并写入缓存。（guavacache）

- 直写

  应用程序写缓存，缓存写数据库。



##### 4.3 Write Behind Caching Pattern（缓存优先模式，适合秒杀等高并发场景，弊端是数据不实时同步）

适合秒杀等高并发场景，短时间内大量读写，可以先写到redis，然后异步刷盘到数据库

- 读

  读缓存，若无数据也直接返回。异步将数据从数据库写入缓存，防止缓存穿透/雪崩/击穿

- 写

  写入缓存，然后通过异步的方式将数据批量或合并后更新到DB中







### 二、缓存架构思想

#### 1. 缓存架构设计思路

##### 1.1 多级缓存

![image-20211219001124074](images/image-20211219001124074.png)

当分布式缓存宕机，本地缓存还可使用



##### 1.2 分布式缓存选择

- Memcached

  简单数据类型，Value是字符串或整数或二进制，Value的值比较大（大于100K），只进行setter和getter，Memcached纯内存缓存，多线程

- Redis

  Value是hash、set、list、zset等丰富的类型存储关系，可聚合，可计算，可持久化，支持事务

##### 1.3 分布式缓存集群

- codis

- 哨兵+主从

- RedisCluster



##### 1.4 数据类型选择





#### 2. 缓存架构设计案例





