<font size=4>

#### 生产者配置
```
package com.csair.framework.config.rocketmq;

import com.bjucloud.mq.client.factory.MQProduceFactory;
import com.csair.framework.config.RocketMqConfig;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.stereotype.Component;

/**
 * @author: Tangdi
 * @date: 9:09 2020/3/6
 * @description:
 * @modify:
 */
@Component
@EnableConfigurationProperties(RocketMqConfig.class)
@Configuration
public class HealthMqBean {

    private static final Logger LOGGER = LoggerFactory.getLogger(HealthMqBean.class);

    private String healthProduceAppName = "CSMBP_Personal";
    private String healthProduceTopicName = "CSMBP_Health_Declaration";
    private String healthConsumeAppName = "CSMBP_Tripstatus";
    private String healthConsumeTopicName = "CSMBP_Health_Declaration";

    /**
     * 初始化producer demo
     *	@param rocketMqConfig
     *	@return
     */
    @Bean
    MQProduceFactory healthMqProducer(RocketMqConfig rocketMqConfig){
        MQProduceFactory mqProduceFactory = new MQProduceFactory();
        try {
            mqProduceFactory.setConfigUrl(rocketMqConfig.getConfigUrl());
            mqProduceFactory.setAppName(healthProduceAppName);
            mqProduceFactory.setTopicName(healthProduceTopicName);
            return mqProduceFactory;
        } catch (Exception e) {
            LOGGER.error("初始化 healthMqProducer 异常",e);
        }
        return mqProduceFactory;
    }
}

```

#### 消费者配置

```
package com.csair.inquire.config.rocketmq;

import com.alibaba.rocketmq.common.protocol.heartbeat.MessageModel;
import com.bjucloud.mq.client.factory.MQConsumerFactory;
import com.csair.inquire.rocketmq.SwitcherChangeListener;
import com.csair.inquire.rocketmq.UpmsAntiOccupySeatListener;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.stereotype.Component;

/**
 * @author: Tangdi
 * @date: 16:34 2020/5/15
 * @description:
 * @modify:
 */
@Component
@EnableConfigurationProperties(RocketMqConfig.class)
@Configuration
public class UpmsAntiOccupySeatMqBean {
    private static final Logger LOGGER= LoggerFactory.getLogger(UpmsAntiOccupySeatMqBean.class);
    private static final String CONSUMER_TOPICNAME = "UPMS_RULES";
    private static final String CONSUMER_APPNAME = "OVERSEA_TOUCH";

    @Bean
    MQConsumerFactory upmsMqConsumer(RocketMqConfig rocketMqConfig, UpmsAntiOccupySeatListener listener){
        MQConsumerFactory mqConsumerFactory = new MQConsumerFactory();
        try {
            mqConsumerFactory.setConfigUrl(rocketMqConfig.getConfigUrl());
            mqConsumerFactory.setAppName(CONSUMER_APPNAME);
            mqConsumerFactory.setTopicName(CONSUMER_TOPICNAME);
            mqConsumerFactory.setListenerConcurrently(listener);
            // 默认为集群模式（平均消费）
            // MessageModel.BROADCASTING为广播模式
            /*mqConsumerFactory.setMessageModel(MessageModel.BROADCASTING);*/
            return mqConsumerFactory;
        } catch (Exception e) {
            LOGGER.error("初始化upmsMqConsumer异常",e);
        }
        return mqConsumerFactory;
    }
}

```

#### 使用生产者
```
@Autowired
MQProduceFactory healthMqProducer;
    
//推送mq至航班动态
healthMqProducer.send(JsonParser.toJsonQuietly(healthDeclarationParam));
```

#### 使用消费者（监听消息）

```
package com.csair.pay.rocketmq;

import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.JSONObject;
import com.alibaba.rocketmq.client.consumer.listener.ConsumeConcurrentlyContext;
import com.alibaba.rocketmq.client.consumer.listener.ConsumeConcurrentlyStatus;
import com.alibaba.rocketmq.client.consumer.listener.MessageListenerConcurrently;
import com.alibaba.rocketmq.common.message.MessageExt;
import com.csair.common.RediskeyConstants;
import com.csair.pay.config.cache.JedisClusterService;
import com.csair.pay.dto.GoXPaymentMqParam;
import com.csair.pay.util.ServerNoUtil;
import com.csair.pay.webServer.xmsg.XmsgService;
import com.csair.util.JsonParser;
import com.csair.util.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.net.InetAddress;
import java.net.UnknownHostException;
import java.util.*;

/**
 * 大订单回调
 * @author: Tangdi
 * @date: 18:09 2019/12/10
 * @description:
 * @modify:
 */
@Component
public class GoXPaymentCallBackMqListener implements MessageListenerConcurrently {
    private static final Logger LOGGER= LoggerFactory.getLogger(GoXPaymentCallBackMqListener.class);

    // mq移动渠道
    private static final String MOBILE = "MOBILE";
    private static final String TRUE = "true";

    @Autowired
    XmsgService xmsgService;
    @Autowired
    private JedisClusterService jedisClusterService;

    @SuppressWarnings({"unchecked", "unused"})
    @Override
    public ConsumeConcurrentlyStatus consumeMessage(List<MessageExt> messages, ConsumeConcurrentlyContext consumeConcurrentlyContext) {
        ServerNoUtil.saveRequestParamToMDC();
        boolean fail = false;
        try {
            MessageExt msg = messages.get(0);
            //producer推到mq的信息
            String text = new String(msg.getBody());
            String mqServerIp = jedisClusterService.get(RediskeyConstants.CSMBP_MQ_CALLBACK_IPS);
            //判断是否需要消费MQ
            boolean needProcessFlag = true;
            if(StringUtils.isNotBlank(mqServerIp)){
                try {
                    //获取服务器ip
                    String server_ip= InetAddress.getLocalHost().getHostAddress();
                    if(!mqServerIp.contains(server_ip)){
                        needProcessFlag = false;
                    }
                } catch (UnknownHostException e) {
                    LOGGER.error(e.getMessage(),e);
                }
            }
            if(needProcessFlag){
                LOGGER.info("goxCallBack consumer获取mq的信息:{}",text);
                GoXPaymentMqParam goxConsumerReq = JsonParser.fromJson(text, GoXPaymentMqParam.class);
                // MOBILE移动渠道处理如下，非移动渠道直接success
                if (goxConsumerReq != null && MOBILE.equals(goxConsumerReq.getAgentFlag())){
                	
                    String res = xmsgService.xOrderpayCallBack(goxConsumerReq);
                    //无X单标示，直接输出成功
                    if("noXOrder".equals(res)){
                    	return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;
                    }
                    if (StringUtils.isNotBlank(res)){
                        // 获取响应体
                        JSONObject jsonObject = JSON.parseObject(res);
                        JSONObject body = jsonObject.getJSONObject("body");

                        // 获取是否请求成功标记,有成功推送的消息为true，全部失败为false
                        String success = String.valueOf(body.get("success"));

                        // 获取返回信息提示
                        JSONObject message = body.getJSONObject("message");
                        JSONObject messageKey = message.getJSONObject("messageKey");
                        String fullText = String.valueOf(message.get("fullText"));
                        String code = String.valueOf(messageKey.get("code"));
                        LOGGER.info("xmsg改x单返回信息,响应码:{},完整信息:{}",code,fullText);

                        if (TRUE.equals(success)){
                            fail = true;
                        }
                    }
                } else {
                    fail = true;
                }
            }else{ //UPP 非移动渠道输出，SUCCESS
                return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;
            }
        } catch (Exception e) {
            LOGGER.error("goxCallBack consumer处理mq信息异常:{}", e);
        }

        if(fail){
            return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;
        }
        return ConsumeConcurrentlyStatus.RECONSUME_LATER;
    }
}

```

#### 消费者二

```
package com.csair.job.messagelistener.flight;

import com.csair.csmbp.logger.CsmbpLogger;
import com.csair.csmbp.logger.CsmbpLoggerFactory;
import com.csair.job.rocketmq.BaseListener;
import com.csair.job.service.health.HealthSmsService;
import com.csair.job.template.csmbp.HealthDeclarationParam;
import com.csair.util.JsonParser;
import com.csair.utils.object.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

/**
 * @author: Tangdi
 * @date: 15:08 2020/3/5
 * @description:
 * @modify:
 */
@Component
public class HealthDeclarationListener extends BaseListener {


    private static final CsmbpLogger LOGGER = CsmbpLoggerFactory.getLogger(HealthDeclarationListener.class);

    @Autowired
    private HealthSmsService healthSmsService;

    @Override
    public boolean doConsume(String msg) {
        boolean fail = false;
        try {
            long start = System.currentTimeMillis();
            LOGGER.error("航班动态消费HealthDeclarationListener.consumeMessage()获取消息数据:{}", msg);
            HealthDeclarationParam message = JsonParser.fromJson(msg, HealthDeclarationParam.class);

            // 健康申明提交成功是否需要短信通知
            boolean sendSms = message.isSendSms();
            if (sendSms){
                boolean isSend = healthSmsService.sendMessage(message);
                if(!isSend){
                    LOGGER.error("发送健康申明提交结果短信失败,用户手机号:{}", StringUtils.maskParter(message.getMobliePhone()));
                }
            }
            LOGGER.error("航班动态消费HealthDeclarationListener.consumeMessage()消息完成消费:{}, 耗时：{}", msg, System.currentTimeMillis()-start);
            fail = true;
        } catch (Exception e) {
            LOGGER.error("HealthDeclarationListener.consumeMessage()消费消息异常.", e);
        }
        if(fail){
            return true;
        }
        return false;
    }
}

```

